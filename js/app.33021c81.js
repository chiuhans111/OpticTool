(function(){var e={8567:function(e,t,s){"use strict";var i=s(9242),a=s(3396),n=s(7139);const r=e=>((0,a.dD)("data-v-604d9ce6"),e=e(),(0,a.Cn)(),e),l={class:"container"},o={class:"row"},u=r((()=>(0,a._)("h2",null,"Optic Tool ",-1))),c=r((()=>(0,a._)("div",null,null,-1))),d=r((()=>(0,a._)("div",null,null,-1))),h={class:"row top_row"},p={class:"row"},m=(0,a.uE)('<div class="row" data-v-604d9ce6><div class="content" data-v-604d9ce6><h3 data-v-604d9ce6>About this project</h3><p data-v-604d9ce6>Developer: <a href="https://chiuhans111.github.io" data-v-604d9ce6>Hans Chiu</a></p><p data-v-604d9ce6>Project repo: <a href="https://github.com/chiuhans111/OpticTool" data-v-604d9ce6>https://github.com/chiuhans111/OpticTool</a></p></div><div class="content" data-v-604d9ce6><h3 data-v-604d9ce6>How to use?</h3><p data-v-604d9ce6>Drag the input box to modify value.</p><p data-v-604d9ce6>Click the input box to edit and set optimization variable.</p></div></div>',1);function f(e,t,s,i,r,f){const v=(0,a.up)("LensPlot"),_=(0,a.up)("AnalyzePlot"),w=(0,a.up)("LensSheet"),y=(0,a.up)("FieldSheet"),b=(0,a.up)("OptimizeWizard");return(0,a.wg)(),(0,a.iD)("div",l,[(0,a._)("div",o,[u,c,(0,a._)("button",{onClick:t[0]||(t[0]=(...e)=>f.open&&f.open(...e))},"Open"),(0,a._)("button",{onClick:t[1]||(t[1]=(...e)=>f.save&&f.save(...e))},"Save"),d,(0,a._)("button",{onClick:t[2]||(t[2]=(...e)=>f.undo&&f.undo(...e))},"Undo "+(0,n.zw)(this.stateHead-1),1),(0,a._)("button",{onClick:t[3]||(t[3]=(...e)=>f.redo&&f.redo(...e))},"Redo "+(0,n.zw)(this.state.length-this.stateHead),1)]),(0,a._)("div",h,[(0,a.Wm)(v,{system:r.system},null,8,["system"]),(0,a.Wm)(_,{system:r.system},null,8,["system"])]),(0,a._)("div",p,[(0,a.Wm)(w,{system:r.system},null,8,["system"]),(0,a.Wm)(y,{system:r.system},null,8,["system"]),(0,a.Wm)(b,{system:r.system},null,8,["system"])]),m])}s(7658);const v={class:"ui_sheet ui_block"},_=(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Lens Data")],-1),w={class:"ui_block-body"},y=["onMousedown"],b={class:"row"},g={class:"ui_sheet-row-ui"},k=["onClick"],z=["onClick"],M={class:"ui_sheet-row"},O={class:"row"},S={class:"ui_sheet-row-ui"},C=(0,a._)("div",{class:"content"},[(0,a._)("p",null,"t=thickness, c=curvature (1/R), n=index of refraction")],-1);function x(e,t,s,i,n,r){const l=(0,a.up)("OpticSurfaceComponent");return(0,a.wg)(),(0,a.iD)("div",v,[_,(0,a._)("div",w,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(s.system.surfaces,((e,t)=>((0,a.wg)(),(0,a.iD)("div",{class:"ui_sheet-row",key:t,onMousedown:t=>r.hover(e)},[(0,a._)("div",b,[(0,a._)("div",g,[(0,a._)("button",{onClick:e=>s.system.surfaces.splice(t,1)},"Del",8,k),(0,a._)("button",{onClick:e=>r.addSurface(t)},"Add",8,z)]),(0,a.Wm)(l,{surface:e},null,8,["surface"])])],40,y)))),128)),(0,a._)("div",M,[(0,a._)("div",O,[(0,a._)("div",S,[(0,a._)("button",{onClick:t[0]||(t[0]=e=>r.addSurface(s.system.surfaces.length))},"Add")])])]),C])])}var D=s(7327);class P{constructor(e){(0,D.Z)(this,"index",1.5),(0,D.Z)(this,"_SP",["index"]),this.index=e}}var E=P;class I{constructor(e){(0,D.Z)(this,"value",0),(0,D.Z)(this,"optimize",!1),(0,D.Z)(this,"_SP",["value","optimize"]),this.value=e||0}}var Z=I,T=s(5789),N=s(4870);function V(e){return e instanceof T.esB?e.arraySync()[0]:e}class U{constructor(e){(0,D.Z)(this,"curvature",new Z(0)),(0,D.Z)(this,"_SP",["curvature"]),this.curvature.value=e}trace(e,t){const s=(0,N.IU)(this.curvature.value);return T.lub((()=>{let i=e.gather(2).div(t.gather(2)).mul(-1);if(0!=V(s)){const a=t.mul(t).sum(0).mul(s),n=e.mul(t).sum(0).mul(s).sub(t.gather(2)).mul(2),r=e.mul(e).sum(0).mul(s).sub(e.gather(2).mul(2));i=n.mul(-1).sub(n.mul(n).sub(a.mul(r).mul(4)).sqrt()).div(a).div(2),a.dispose(),n.dispose(),r.dispose()}return e.add(t.mul(i))}))}normal(e){const t=(0,N.IU)(this.curvature.value);return T.lub((()=>{let s=e.mul(0).add(T.XeE([[0],[0],[-1]]));if(0!=V(t)){let i=e.sub(T.XeE([[0],[0],[1]]).div(t));s=i.div(i.mul(i).sum(0).sqrt())}return s}))}surface(e){const t=e**2;return t*this.curvature.value/(1+Math.sqrt(1-t*this.curvature.value**2))}}var L=U;class W{constructor(e,t,s){(0,D.Z)(this,"thickness",new Z(0)),(0,D.Z)(this,"shape",new L(0)),(0,D.Z)(this,"material",new E(1.5)),(0,D.Z)(this,"_SP",["thickness","shape","material"]),this.thickness.value=e||this.thickness.value,this.shape.curvature.value=t||this.shape.curvature.value,this.material=s||this.material}}var j=W;class H{constructor(e){(0,D.Z)(this,"angle",new Z(0)),(0,D.Z)(this,"_SP",["angle"]),this.angle.value=e||this.angle.value}raypos(e,t,s){const i=s.pupilDiameter.value/2,a=s.pupilOffset.value,n=this.angle.value,r=-1,l=e*i,o=t*i+(a-r)*Math.sin(n/180*Math.PI);return[l,o,r]}raydir(e,t){return[0,-Math.sin(this.angle.value/180*Math.PI),Math.cos(this.angle.value/180*Math.PI)]}}var X=H;class ${constructor(){(0,D.Z)(this,"surfaces",[new j(3,.066667,new E(1.515)),new j(4,-.01316,new E(1)),new j(1.5,-.05882,new E(1.6438)),new j(2.5,.0625,new E(1)),new j(3,.022727,new E(1.515)),new j(40,-.07143,new E(1)),new j(0,0,new E(1))]),(0,D.Z)(this,"fields",[new X(0),new X(10),new X(20)]),(0,D.Z)(this,"pupilDiameter",new Z(10)),(0,D.Z)(this,"pupilOffset",new Z(10)),(0,D.Z)(this,"update",0),(0,D.Z)(this,"_SP",["surfaces","fields","pupilDiameter","pupilOffset"])}}var F=$;const A=(0,a._)("label",{for:"curvature"},"c=",-1),R=(0,a._)("span",null,", ",-1),q=(0,a._)("label",{for:"thickness"},"t=",-1),B=(0,a._)("span",null,", ",-1),J=(0,a._)("label",{for:"material"},"n=",-1);function K(e,t,s,r,l,o){const u=(0,a.up)("OpticVarInput");return(0,a.wg)(),(0,a.iD)("div",null,[A,(0,a.Wm)(u,{id:"curvature",type:"number",step:1e-4,variable:s.surface.shape.curvature},null,8,["step","variable"]),R,q,(0,a.Wm)(u,{id:"thickness",step:.01,variable:s.surface.thickness},null,8,["step","variable"]),B,J,(0,a.wy)((0,a._)("input",{id:"material",type:"number",step:"0.01",min:"1",max:"99","onUpdate:modelValue":t[0]||(t[0]=e=>s.surface.material.index=e)},null,512),[[i.nr,s.surface.material.index,void 0,{number:!0}]]),(0,a._)("span",null," (R="+(0,n.zw)((1/s.surface.shape.curvature.value).toPrecision(4))+") ",1)])}const Y=e=>((0,a.dD)("data-v-6ddc2af9"),e=e(),(0,a.Cn)(),e),Q=["step"],G={class:"ui_block"},ee={class:"ui_block-body"},te={class:"content"},se=Y((()=>(0,a._)("label",{for:"optimize"},"Optimize",-1)));function ie(e,t,s,r,l,o){return(0,a.wg)(),(0,a.iD)("div",{class:(0,n.C_)(["optic_var_input",{"optic_var_input-editmode":l.editmode,"optic_var_input-optimize":s.variable.optimize}])},[(0,a.wy)((0,a._)("input",{class:"draggable",ref:"input",type:"number","onUpdate:modelValue":t[0]||(t[0]=e=>s.variable.value=e),step:s.step},null,8,Q),[[i.nr,s.variable.value]]),l.editmode?((0,a.wg)(),(0,a.iD)("div",{key:0,ref:"menu",class:"optic_var_input-menu",onMousedown:t[2]||(t[2]=(...e)=>o.menuclick&&o.menuclick(...e))},[(0,a._)("div",G,[(0,a._)("div",ee,[(0,a._)("div",te,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"optimize",id:"optimize","onUpdate:modelValue":t[1]||(t[1]=e=>s.variable.optimize=e)},null,512),[[i.e8,s.variable.optimize]]),se])])])],544)):(0,a.kq)("",!0)],2)}function ae(e,t){let s=null,i=!1,a=null,n=[];async function r(){i=!0,a=this,n=arguments,null==s&&(s=0,await t.apply(a,n),i=!1,s=setTimeout((function(){s=null,i&&r.apply(a,n)}),e))}return r}function ne(e,t){let s=null,i=!1,a=null,n=[];function r(){i=!0,a=this,n=arguments,null==s&&(t.apply(a,n),i=!1,s=setTimeout((function(){s=null,i&&r.apply(a,n)}),e))}return r}var re={props:{variable:Z,step:Number},data(){return{editmode:!1,tweakmode:!1,tweaked:!1,tempValue:this.variable.value}},methods:{mousedown(e){this.tempValue=this.variable.value,this.editmode||(e.preventDefault(),this.tweakmode=!0,this.tweaked=!1)},mouseup(e){this.tweakmode&&!this.tweaked&&(this.editmode=!0,this.tweakmode=!1,this.$refs.input.focus()),this.tweakmode=!1},mousemove(e){this.tweakmode&&(this.tweaked=!0,this.tempValue+=e.movementX*this.step,this.updatevalue())},reset(e){this.editmode=!1,this.tweakmode=!1},menuclick(e){e.preventDefault()},updatevalue:ne(10,(function(){this.variable.value=this.tempValue}))},mounted(){this.$refs.input.addEventListener("mousedown",this.mousedown),addEventListener("mouseup",this.mouseup),addEventListener("mousemove",this.mousemove),this.$refs.input.addEventListener("blur",this.reset)},beforeUnmount(){this.$refs.input.removeEventListener("mousedown",this.mousedown),removeEventListener("mouseup",this.mouseup),removeEventListener("mousemove",this.mousemove),this.$refs.input.removeEventListener("blur",this.reset)}},le=s(89);const oe=(0,le.Z)(re,[["render",ie],["__scopeId","data-v-6ddc2af9"]]);var ue=oe,ce={props:{surface:j},components:{OpticVarInput:ue},data(){return{}}};const de=(0,le.Z)(ce,[["render",K]]);var he=de;const pe={focusedSurface:null,colorlist:["red","green","blue","yellow","cyan","magenta"]};var me=pe,fe={props:{system:F},components:{OpticSurfaceComponent:he},methods:{addSurface(e){this.system.surfaces.splice(e,0,new j)},hover(e){me.focusedSurface=e}}};const ve=(0,le.Z)(fe,[["render",x]]);var _e=ve;const we=e=>((0,a.dD)("data-v-2b913eb6"),e=e(),(0,a.Cn)(),e),ye={class:"lens_plot ui_block"},be=we((()=>(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Plot")],-1))),ge={class:"ui_block-body"},ke={ref:"container",class:"lens_plot-container"},ze={ref:"canvas"};function Me(e,t,s,i,n,r){return(0,a.wg)(),(0,a.iD)("div",ye,[be,(0,a._)("div",ge,[(0,a._)("div",ke,[(0,a._)("canvas",ze,null,512)],512)])])}function Oe(e,t,s){return T.lub((()=>{let i=[];i.push(t);let a=1,n=T.XeE(0);for(let r of e.surfaces){let e=r.material.index;t=r.shape.trace(t.sub(T.XeE([[0],[0],[1]]).mul(n)),s);let l=r.shape.normal(t);s=s.div(s.mul(s).sum(0).sqrt()).mul(a),l=l.mul(s.mul(l).sum(0).sign());let o=s.mul(l).sum(0),u=T.luU(a**2,o.mul(o)),c=T.luU(e**2,u).sqrt().sub(T.luU(a**2,u).sqrt());s=s.add(l.mul(c)),t=t.add(T.XeE([[0],[0],[1]]).mul(n)),i.push(t),a=e,n=n.add((0,N.IU)(r.thickness.value))}return i}))}var Se=Oe;function Ce(e){let t=[],s=[],i=7;for(let a=0;a<=i;a++)for(let n of e.fields){let r=2*(a/i-.5);t.push(n.raypos(0,r,e)),s.push(n.raydir(0,r,e))}return t=T.XeE(t).transpose(),s=T.XeE(s).transpose(),Se(e,t,s)}var xe=Ce,De={props:{system:F},data(){return{canvas:null,ctx:null,ViewState:me}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:ae(10,(async function(){const e=this.canvas,t=this.ctx,s=await Promise.all(xe(this.system).map((e=>e.array())));t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2);let i=0;for(let u of this.system.surfaces)i+=u.thickness.value;let a=[],n=0;for(let u=1;u<s.length;u++){let e=0;for(let t=0;t<s[0][0].length;t++){let i=s[u][1][t];isNaN(i)||(e=Math.max(e,Math.abs(i)))}a.push(e),n=Math.max(e,n)}let r=e.width/i*.9;r=Math.min(r,e.height/n/2*.9),t.scale(r,r),t.translate(-i/2,0),t.lineWidth=2/r,t.strokeStyle="#333",t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.stroke(),t.strokeStyle="#EEE";const l=50;let o=0;t.fillStyle="#111";for(let u=0;u<this.system.surfaces.length;u++){let e=this.system.surfaces[u],s=a[u],i=u<this.system.surfaces.length-1&&e.material.index>1;i&&(s=Math.max(s,a[u+1])),t.beginPath();for(let a=0;a<=l;a++){let i=2*(a/l-.5)*s,n=e.shape.surface(i);isNaN(i)||isNaN(n)||(0==a?t.moveTo(o+n,i):t.lineTo(o+n,i))}if(i){let i=this.system.surfaces[u+1];for(let a=0;a<=l;a++){let n=2*-(a/l-.5)*s,r=i.shape.surface(n);isNaN(n)||isNaN(r)||t.lineTo(o+r+e.thickness.value,n)}t.closePath(),t.fill()}if(t.stroke(),e==me.focusedSurface){t.save(),t.strokeStyle="orange",t.lineWidth=3/r,t.beginPath();for(let i=0;i<=l;i++){let a=2*(i/l-.5)*s,n=e.shape.surface(a);isNaN(a)||isNaN(n)||(0==i?t.moveTo(o+n,a):t.lineTo(o+n,a))}t.stroke(),t.restore()}o+=e.thickness.value}t.lineWidth=1.5/r;for(let u=0;u<s[0][0].length;u++){t.strokeStyle=me.colorlist[u%this.system.fields.length%me.colorlist.length],t.beginPath();for(let e=0;e<s.length;e++){let i=s[e][1][u],a=s[e][2][u];0==e?t.moveTo(a,i):t.lineTo(a,i)}t.stroke()}}),50)},watch:{system:{handler(){this.update()},deep:!0},ViewState:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const Pe=(0,le.Z)(De,[["render",Me],["__scopeId","data-v-2b913eb6"]]);var Ee=Pe;T.CQI("cpu");const Ie=new F;var Ze={system:Ie};class Te{constructor(e){(0,D.Z)(this,"classes",{});for(let t of e)this.classes[t.name]=t}serialize(e){return JSON.stringify(this._serialize(e))}_serialize(e){if(e._SP){let t={_class:e.constructor.name};for(let s of e._SP)t[s]=this._serialize(e[s]);return t}if(e instanceof Array)return e.map((e=>this._serialize(e)));if(e instanceof Object){let t={};for(let s in e)t[s]=this._serialize(e[s]);return t}return e}deserialize(e,t){return this._deserialize(JSON.parse(e),t)}_deserialize(e){if(e._class){let t=this.classes[e._class];if(t){let s=new t;for(let t of s._SP)s[t]=this._deserialize(e[t]);return s}console.error("no class define:",e._class)}else{if(e instanceof Array)return e.map((e=>this._deserialize(e)));if(e instanceof Object){let t={};for(let s in e)t[s]=this._deserialize(e[s]);return t}}return e}}const Ne=new Te([F,j,Z,X,L,E]);var Ve=Ne;const Ue={class:"ui_sheet ui_block"},Le=(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Field Data")],-1),We={class:"ui_block-body"},je={class:"content"},He=(0,a._)("label",{for:"diameter"},"D=",-1),Xe=(0,a._)("label",{for:"Z"},"Z=",-1),$e={class:"row"},Fe={class:"ui_sheet-row-ui"},Ae=["onClick"],Re=["onClick"],qe={class:"ui_sheet-row"},Be={class:"row"},Je={class:"ui_sheet-row-ui"},Ke=(0,a._)("div",{class:"content"},[(0,a._)("p",null,"D=Entrance Diameter, Z=Distance to the pupil")],-1);function Ye(e,t,s,i,n,r){const l=(0,a.up)("OpticVarInput"),o=(0,a.up)("OpticFieldComponent");return(0,a.wg)(),(0,a.iD)("div",Ue,[Le,(0,a._)("div",We,[(0,a._)("div",je,[He,(0,a.Wm)(l,{id:"diameter",step:.01,variable:s.system.pupilDiameter},null,8,["step","variable"]),Xe,(0,a.Wm)(l,{id:"Z",step:.01,variable:s.system.pupilOffset},null,8,["step","variable"])]),((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(s.system.fields,((e,t)=>((0,a.wg)(),(0,a.iD)("div",{class:"ui_sheet-row",key:t},[(0,a._)("div",$e,[(0,a._)("div",Fe,[(0,a._)("button",{onClick:e=>s.system.fields.splice(t,1)},"Del",8,Ae),(0,a._)("button",{onClick:e=>r.addField(t)},"Add",8,Re)]),(0,a.Wm)(o,{field:e},null,8,["field"])])])))),128)),(0,a._)("div",qe,[(0,a._)("div",Be,[(0,a._)("div",Je,[(0,a._)("button",{onClick:t[0]||(t[0]=e=>r.addField(s.system.fields.length))},"Add")])])]),Ke])])}const Qe=(0,a._)("label",{for:"angle"},"angle=",-1);function Ge(e,t,s,i,n,r){const l=(0,a.up)("OpticVarInput");return(0,a.wg)(),(0,a.iD)("div",null,[Qe,(0,a.Wm)(l,{id:"angle",step:.02,variable:s.field.angle},null,8,["step","variable"])])}var et={props:{field:X},components:{OpticVarInput:ue},data(){return{}}};const tt=(0,le.Z)(et,[["render",Ge]]);var st=tt,it={props:{system:F},components:{OpticFieldComponent:st,OpticVarInput:ue},methods:{addField(e){this.system.fields.splice(e,0,new X)}}};const at=(0,le.Z)(it,[["render",Ye]]);var nt=at;const rt=e=>((0,a.dD)("data-v-4a6eace6"),e=e(),(0,a.Cn)(),e),lt={class:"analyze_plot ui_block"},ot=rt((()=>(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Spot Diagram")],-1))),ut={class:"ui_block-body"},ct={ref:"container",class:"analyze_plot-container"},dt={ref:"canvas"};function ht(e,t,s,i,n,r){return(0,a.wg)(),(0,a.iD)("div",lt,[ot,(0,a._)("div",ut,[(0,a._)("div",ct,[(0,a._)("canvas",dt,null,512)],512)])])}function pt(e){let t=[],s=[],i=5;for(let r=0;r<=i;r++){let a=r/i,n=16*a+1;for(let i=0;i<n;i++){let r=i/n,l=a*Math.cos(r*Math.PI*2),o=a*Math.sin(r*Math.PI*2);for(let i of e.fields)t.push(i.raypos(l,o,e)),s.push(i.raydir(l,o,e))}}t=T.XeE(t).transpose(),s=T.XeE(s).transpose();let a=Se(e,t,s),n=a[a.length-1];return n}var mt=pt,ft={props:{system:F},data(){return{canvas:null,ctx:null}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:ae(10,(async function(){const e=this.canvas,t=this.ctx,s=await mt(this.system).array();t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2),t.beginPath();let i=s[1][0],a=s[1][0];for(let r=0;r<s[0].length;r++){let e=s[1][r];isNaN(e)||(i=Math.max(e,i),a=Math.min(e,a))}let n=e.height/(i-a+2)*.8;t.scale(n,n),t.translate(0,-(i+a)/2),t.lineWidth=1/n;for(let r=0;r<s[0].length;r++){t.beginPath(),t.strokeStyle=me.colorlist[r%this.system.fields.length%me.colorlist.length];let e=s[0][r],i=s[1][r];t.rect(e-1/n,i-1/n,2/n,2/n),t.stroke()}}))},watch:{system:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const vt=(0,le.Z)(ft,[["render",ht],["__scopeId","data-v-4a6eace6"]]);var _t=vt;const wt=e=>((0,a.dD)("data-v-2fd3bb79"),e=e(),(0,a.Cn)(),e),yt={class:"optimize_wizard ui_block"},bt=wt((()=>(0,a._)("div",{class:"ui_block-header"},"Optimizer",-1))),gt={class:"ui_block-body"},kt={class:"row content"},zt=wt((()=>(0,a._)("label",{for:"updateOnSystemChange"},"Update merit on change",-1))),Mt={class:"row content"},Ot={class:"row content"},St={class:"row content"},Ct=wt((()=>(0,a._)("label",{for:"maxIteration"},"Max:",-1))),xt={class:"row content"},Dt=wt((()=>(0,a._)("label",{for:"updateView"},"Update view",-1)));function Pt(e,t,s,r,l,o){return(0,a.wg)(),(0,a.iD)("div",yt,[bt,(0,a._)("div",gt,[(0,a._)("div",kt,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"updateOnSystemChange",id:"updateOnSystemChange","onUpdate:modelValue":t[0]||(t[0]=e=>l.updateOnSystemChange=e)},null,512),[[i.e8,l.updateOnSystemChange]]),zt]),(0,a._)("div",Mt,[(0,a._)("p",null,"Current Merit: "+(0,n.zw)(l.merit.toPrecision(6)),1)]),(0,a._)("div",Ot,[(0,a._)("button",{onClick:t[1]||(t[1]=(...e)=>o.updateMerit&&o.updateMerit(...e))},"Calculate Current"),this.iterate?((0,a.wg)(),(0,a.iD)("button",{key:0,onClick:t[2]||(t[2]=(...e)=>o.stop&&o.stop(...e))},"Stop!")):((0,a.wg)(),(0,a.iD)("button",{key:1,onClick:t[3]||(t[3]=(...e)=>o.optimize&&o.optimize(...e))},"Optimize!"))]),(0,a._)("div",St,[Ct,(0,a.wy)((0,a._)("input",{type:"number",name:"maxIteration",id:"maxIteration","onUpdate:modelValue":t[4]||(t[4]=e=>l.maxIteration=e)},null,512),[[i.nr,l.maxIteration]]),(0,a._)("p",null,"Iterations: "+(0,n.zw)(l.iterations),1)]),(0,a._)("div",xt,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"updateView",id:"updateView","onUpdate:modelValue":t[5]||(t[5]=e=>l.updateView=e)},null,512),[[i.e8,l.updateView]]),Dt])])])}function Et(e){return T.lub((()=>{let t=T.XeE([0]);for(let s of e.fields)t=T.lub((()=>{const i=[],a=[],n=3;for(let t=0;t<=n;t++){const r=t/n,l=3*r+1;for(let t=0;t<=l;t++){const n=t/l-.5,o=r*Math.cos(n*Math.PI),u=r*Math.sin(n*Math.PI);i.push(s.raypos(o,u,e)),a.push(s.raydir(o,u,e))}}const r=T.XeE(i).transpose(),l=T.XeE(a).transpose(),o=Se(e,r,l),u=o[o.length-1],c=u.sub(u.gather(0,1).expandDims(1)),d=c.mul(c),h=d.isNaN().logicalNot(),p=d.where(h,0).max().add(1e5);return t.add(d.where(h,p).sum())}));return t}))}var It=Et;async function Zt(e){let t=[];t.push(e.pupilOffset);for(let f of e.surfaces)t.push(f.shape.curvature),t.push(f.thickness);t=t.filter((e=>e.optimize));let s=t.map(N.IU),i=s.map((e=>e.value));async function a(t){return s.map(((e,s)=>{e.value=t[s]})),(await It(e).array())[0]}async function n(e,t){for(let s=0;s<e.length;s++)t[s]=await a(e[s])}const r=[i];r.push(i.map((e=>e+1*(Math.random()-.5)))),r.push(i.map((e=>e+.01*(Math.random()-.5)))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1)));const l=r.length,o=[],u=[],c=[];await n(r,o);let d=o[0],h=r[0];async function p(e=.9){for(let t=0;t<l;t++){const s=Math.floor(Math.random()*l),i=Math.floor(Math.random()*l),a=Math.floor(Math.random()*l),n=Math.floor(Math.random()*l),o=r[s],u=r[i],d=r[a];c[t]=r[t].map(((t,s)=>s!==n&&Math.random()<.3?t:o[s]+(u[s]-d[s])*e))}await n(c,u);for(let t=0;t<l;t++)!isNaN(u[t])&&u[t]<o[t]&&(o[t]=u[t],r[t]=c[t],(isNaN(d)||o[t]<d)&&(d=o[t],h=r[t]));return d}function m(){s.map(((e,t)=>{e.value=null})),t.map(((e,t)=>{e.value=h[t]}))}return[p.bind(this),m.bind(this)]}var Tt=Zt,Nt={props:{system:F},data(){return{merit:0,iterate:null,apply:null,iterations:0,maxIteration:20,timeout:null,updateOnSystemChange:!0,updateView:!1}},methods:{updateMerit:ne(10,(function(){this.merit=It(this.system).arraySync()[0]})),async optimize(){this.iterations=0;let[e,t]=await Tt(this.system);this.iterate=e,this.apply=t,this.update()},update(){if(this.timeout&&clearTimeout(this.timeout),this.iterations>=this.maxIteration)this.stop();else if(this.iterate){let e=this;this.iterate().then((t=>{this.merit=t,this.updateView&&this.apply(),e.timeout=setTimeout((()=>{e.iterations+=1,e.update()}),0)}))}},stop(){this.apply&&(this.system.update+=1,this.apply(),this.apply=null),this.updateMerit(),this.iterate=null,clearTimeout(this.timeout),this.timeout=null}},watch:{system:{handler(){this.updateOnSystemChange&&!this.iterate&&this.updateMerit()},deep:!0}}};const Vt=(0,le.Z)(Nt,[["render",Pt],["__scopeId","data-v-2fd3bb79"]]);var Ut=Vt;function Lt(e,t){let s=null,i=null,a=[];function n(){i=this,a=arguments,s&&clearTimeout(s),s=setTimeout((function(){t.apply(i,a),s=null}),e)}return n}var Wt={name:"App",data(){return{system:Ze.system,state:[],no_record:!1,stateHead:0}},components:{LensSheet:_e,LensPlot:Ee,FieldSheet:nt,AnalyzePlot:_t,OptimizeWizard:Ut},mounted(){this.push()},methods:{undo(){this.no_record=!0,this.stateHead>1&&this.stateHead--,this.state.length>0&&this.load(this.state[this.stateHead-1])},redo(){this.no_record=!0,this.stateHead<this.state.length&&this.stateHead++,this.state.length>0&&this.load(this.state[this.stateHead-1])},load(e){this.system=Ve.deserialize(e)},push:Lt(200,ne(500,(function(){this.state.splice(this.stateHead);let e=Ve.serialize((0,N.IU)(this.system));0!=this.state.length&&e===this.state[this.state.length-1]||(this.state.push(e),this.stateHead+=1)}))),open(){let e=document.createElement("input");e.type="file";let t=this;e.onchange=function(){const s=new FileReader;s.readAsText(e.files[0],"UTF-8"),s.onload=function(e){t.load(e.target.result),console.log(e.target.result)}},e.click()},save(){let e="lens.json";var t=Ve.serialize((0,N.IU)(this.system)),s=new Blob([t],{type:"text/plain"});new File([s],e,{type:"text/plain"});let i=document.createElement("a");document.createEvent("MouseEvents");i.download=e,i.href=window.URL.createObjectURL(s),i.dataset.downloadurl=["text/obj",i.download,i.href].join(":"),i.click()}},watch:{system:{handler(){this.no_record||this.push(),this.no_record=!1},deep:!0}}};const jt=(0,le.Z)(Wt,[["render",f],["__scopeId","data-v-604d9ce6"]]);var Ht=jt;(0,i.ri)(Ht).mount("#app")},5410:function(){},8628:function(){},1601:function(){},7792:function(){},4977:function(){},5042:function(){}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=e,function(){s.amdD=function(){throw new Error("define cannot be used indirect")}}(),function(){s.amdO={}}(),function(){var e=[];s.O=function(t,i,a,n){if(!i){var r=1/0;for(c=0;c<e.length;c++){i=e[c][0],a=e[c][1],n=e[c][2];for(var l=!0,o=0;o<i.length;o++)(!1&n||r>=n)&&Object.keys(s.O).every((function(e){return s.O[e](i[o])}))?i.splice(o--,1):(l=!1,n<r&&(r=n));if(l){e.splice(c--,1);var u=a();void 0!==u&&(t=u)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[i,a,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var a,n,r=i[0],l=i[1],o=i[2],u=0;if(r.some((function(t){return 0!==e[t]}))){for(a in l)s.o(l,a)&&(s.m[a]=l[a]);if(o)var c=o(s)}for(t&&t(i);u<r.length;u++)n=r[u],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},i=self["webpackChunkoptictool"]=self["webpackChunkoptictool"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[998],(function(){return s(8567)}));i=s.O(i)})();
//# sourceMappingURL=app.33021c81.js.map