(function(){var e={57:function(e,t,s){"use strict";var a=s(9242),i=s(3396),n=s(7139);const l=e=>((0,i.dD)("data-v-9c94eec8"),e=e(),(0,i.Cn)(),e),r={class:"container"},o={class:"row"},u=l((()=>(0,i._)("h2",null,"Optic Tool ",-1))),c=l((()=>(0,i._)("div",null,null,-1))),d=l((()=>(0,i._)("div",null,null,-1))),h={class:"row top_row"},p={class:"row"},m=(0,i.uE)('<div class="row" data-v-9c94eec8><div class="content" data-v-9c94eec8><h3 data-v-9c94eec8>About this project</h3><p data-v-9c94eec8>Developer: <a href="https://chiuhans111.github.io" data-v-9c94eec8>Hans Chiu</a></p><p data-v-9c94eec8>Project repo: <a href="https://github.com/chiuhans111/OpticTool" data-v-9c94eec8>https://github.com/chiuhans111/OpticTool</a></p></div><div class="content" data-v-9c94eec8><h3 data-v-9c94eec8>How to use?</h3><p data-v-9c94eec8>Drag the input box to modify value.</p><p data-v-9c94eec8>Click the input box to edit and set optimization variable.</p></div></div>',1);function f(e,t,s,a,l,f){const v=(0,i.up)("LensPlot"),_=(0,i.up)("AnalyzePlot"),b=(0,i.up)("LensSheet"),w=(0,i.up)("FieldSheet"),y=(0,i.up)("OptimizeWizard");return(0,i.wg)(),(0,i.iD)("div",r,[(0,i._)("div",o,[u,c,(0,i._)("button",{onClick:t[0]||(t[0]=(...e)=>f.open&&f.open(...e))},"Open"),(0,i._)("button",{onClick:t[1]||(t[1]=(...e)=>f.save&&f.save(...e))},"Save"),d,(0,i._)("button",{onClick:t[2]||(t[2]=(...e)=>f.undo&&f.undo(...e))},"Undo "+(0,n.zw)(this.stateHead-1),1),(0,i._)("button",{onClick:t[3]||(t[3]=(...e)=>f.redo&&f.redo(...e))},"Redo "+(0,n.zw)(this.state.length-this.stateHead),1)]),(0,i._)("div",h,[(0,i.Wm)(v,{system:l.system},null,8,["system"]),(0,i.Wm)(_,{system:l.system},null,8,["system"])]),(0,i._)("div",p,[(0,i.Wm)(b,{system:l.system},null,8,["system"]),(0,i.Wm)(w,{system:l.system},null,8,["system"]),(0,i.Wm)(y,{system:l.system},null,8,["system"])]),m])}s(7658);const v={class:"ui_sheet ui_block"},_=(0,i._)("div",{class:"ui_block-header"},[(0,i._)("p",null,"Lens Data")],-1),b={class:"ui_block-body"},w=(0,i._)("div",{class:"content"},[(0,i._)("p",null,"t=thickness, c=curvature (1/R), n=index of refraction")],-1);function y(e,t,s,a,n,l){const r=(0,i.up)("OpticSurfaceComponent"),o=(0,i.up)("SheetUI");return(0,i.wg)(),(0,i.iD)("div",v,[_,(0,i._)("div",b,[(0,i.Wm)(o,{list:s.system.surfaces,builder:l.buildSurface},{item:(0,i.w5)((([e,t])=>[((0,i.wg)(),(0,i.j4)(r,{surface:e,key:t},null,8,["surface"]))])),_:1},8,["list","builder"]),w])])}var g=s(7327);function k(e){return e=e.replaceAll(/"([^",{}]+)":/g,"$1:"),e=e.replaceAll(/{_:"([^",{}]+)",/g,"{$1,"),e=e.replaceAll(/true/g,"_1"),e=e.replaceAll(/false/g,"_0"),e}function z(e){return e=e.replaceAll(/_1/g,"true"),e=e.replaceAll(/_0/g,"false"),e=e.replaceAll(/{([^",{}]+),/g,'{_:"$1",'),e=e.replaceAll(/([^,"{}]+):/g,'"$1":'),e}class M{constructor(){(0,g.Z)(this,"classdefs",{}),(0,g.Z)(this,"classnames",{})}serializable(e,t){const s=this;return function(a){e in s.classdefs&&console.error("duplicated classname",e),a.name in s.classnames&&console.error("duplicated class",a.name);const i={};for(let e in t)i[t[e]]=e;return s.classdefs[e]={Class:a,param2v:t,v2param:i},s.classnames[a.name]=e,a}}serialize(e){return k(JSON.stringify(this._serialize(e)))}_serialize(e){if(e instanceof Array)return e.map((e=>this._serialize(e)));if(e instanceof Object){const t={};if(e.constructor.name in this.classnames){t._=this.classnames[e.constructor.name];const s=this.classdefs[t._].param2v;for(let a in s)t[s[a]]=this._serialize(e[a])}else for(let s in e)t[s]=this._serialize(e[s]);return t}return e}deserialize(e,t){return this._deserialize(JSON.parse(z(e)),t)}_deserialize(e){if(e instanceof Array)return e.map((e=>this._deserialize(e)));if(e instanceof Object){if(e._&&e._ in this.classdefs){const t=this.classdefs[e._],s=new t.Class,a=t.v2param;for(let i in a)s[a[i]]=this._deserialize(e[i]);return s}{const t={};for(let s in e)t[s]=this._deserialize(e[s]);return t}}return e}}const O=new M;var x,I,C=O;let S=(x=C.serializable("n",{index:"n"}),x(I=class{constructor(e){(0,g.Z)(this,"index",1.5),this.index=e}})||I);var D,E,Z=S;let P=(D=C.serializable("v",{value:"v",optimize:"o"}),D(E=class{constructor(e){(0,g.Z)(this,"value",0),(0,g.Z)(this,"optimize",!1),this.value=e||0}})||E);var T,U,N=P,V=s(5789),W=s(4870);function L(e){return e instanceof V.esB?e.arraySync()[0]:e}let $=(T=C.serializable("o",{curvature:"c"}),T(U=class{constructor(e){(0,g.Z)(this,"curvature",new N(0)),this.curvature.value=e}trace(e,t){const s=(0,W.IU)(this.curvature.value);return V.lub((()=>{let a=e.gather(2).div(t.gather(2)).mul(-1);if(0!=L(s)){const i=t.mul(t).sum(0).mul(s),n=e.mul(t).sum(0).mul(s).sub(t.gather(2)).mul(2),l=e.mul(e).sum(0).mul(s).sub(e.gather(2).mul(2));a=n.mul(-1).sub(n.mul(n).sub(i.mul(l).mul(4)).sqrt()).div(i).div(2),i.dispose(),n.dispose(),l.dispose()}return e.add(t.mul(a))}))}normal(e){const t=(0,W.IU)(this.curvature.value);return V.lub((()=>{let s=e.mul(0).add(V.XeE([[0],[0],[-1]]));if(0!=L(t)){let a=e.sub(V.XeE([[0],[0],[1]]).div(t));s=a.div(a.mul(a).sum(0).sqrt())}return s}))}surface(e){const t=e**2;return t*this.curvature.value/(1+Math.sqrt(1-t*this.curvature.value**2))}})||U);var j,A,H=$;let F=(j=C.serializable("s",{thickness:"t",shape:"s",material:"n"}),j(A=class{constructor(e,t,s){(0,g.Z)(this,"thickness",new N(0)),(0,g.Z)(this,"shape",new H(0)),(0,g.Z)(this,"material",new Z(1.5)),this.thickness.value=e||this.thickness.value,this.shape.curvature.value=t||this.shape.curvature.value,this.material=s||this.material}})||A);var X,R,q=F;let B=(X=C.serializable("f",{angle:"a"}),X(R=class{constructor(e){(0,g.Z)(this,"angle",new N(0)),this.angle.value=e||this.angle.value}raypos(e,t,s){const a=s.pupilDiameter.value/2,i=s.pupilOffset.value,n=this.angle.value,l=-1,r=e*a,o=t*a+(i-l)*Math.sin(n/180*Math.PI);return[r,o,l]}raydir(e,t){return[0,-Math.sin(this.angle.value/180*Math.PI),Math.cos(this.angle.value/180*Math.PI)]}})||R);var J,K,Q=B;let Y=(J=C.serializable("$",{surfaces:"s",fields:"f",pupilDiameter:"D",pupilOffset:"Z"}),J(K=class{constructor(){(0,g.Z)(this,"surfaces",[new q(3,.066667,new Z(1.515)),new q(4,-.01316,new Z(1)),new q(1.5,-.05882,new Z(1.6438)),new q(2.5,.0625,new Z(1)),new q(3,.022727,new Z(1.515)),new q(40,-.07143,new Z(1)),new q(0,0,new Z(1))]),(0,g.Z)(this,"fields",[new Q(0),new Q(10),new Q(20)]),(0,g.Z)(this,"pupilDiameter",new N(10)),(0,g.Z)(this,"pupilOffset",new N(10)),(0,g.Z)(this,"update",0)}})||K);var G=Y;const ee={class:"ui_sheet"},te={class:"row"},se={class:"ui_sheet-row-ui"},ae=["onClick"],ie=["onClick"],ne={class:"ui_sheet-row"},le={class:"row"};function re(e,t,s,l,r,o){return(0,i.wg)(),(0,i.iD)("div",ee,[(0,i.Wm)(a.W3,{name:"list",tag:"div",class:"ui_sheet-group"},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(s.list,((t,s)=>((0,i.wg)(),(0,i.iD)("div",{class:"ui_sheet-row list-item",key:o.getid(t)},[(0,i._)("div",te,[(0,i._)("div",se,[(0,i._)("button",{class:"ui_sheet-btn",onClick:e=>o.delItem(s)},"Del",8,ae),(0,i._)("button",{class:"ui_sheet-btn",onClick:e=>o.addItem(s)},"Add",8,ie)]),(0,i.WI)(e.$slots,"item",(0,n.vs)((0,i.F4)([t,s])))])])))),128))])),_:3}),(0,i._)("div",ne,[(0,i._)("div",le,[(0,i._)("button",{onClick:t[0]||(t[0]=e=>o.addItem(s.list.length))},"Add")])])])}var oe={props:{list:Array,builder:Function},methods:{addItem(e){this.list.splice(e,0,this.builder(e))},delItem(e){this.list.splice(e,1)},getid(e){if(e=(0,W.IU)(e),void 0===e._id_){let t=0;while(this.list.some((e=>e._id_==t)))t++;e._id_=t}return e._id_}}},ue=s(89);const ce=(0,ue.Z)(oe,[["render",re]]);var de=ce;const he=(0,i._)("label",{for:"curvature"},"c=",-1),pe=(0,i._)("span",null,", ",-1),me=(0,i._)("label",{for:"thickness"},"t=",-1),fe=(0,i._)("span",null,", ",-1),ve=(0,i._)("label",{for:"material"},"n=",-1);function _e(e,t,s,l,r,o){const u=(0,i.up)("OpticVarInput");return(0,i.wg)(),(0,i.iD)("tr",null,[he,(0,i.Wm)(u,{id:"curvature",type:"number",step:1e-4,variable:s.surface.shape.curvature},null,8,["step","variable"]),pe,me,(0,i.Wm)(u,{id:"thickness",step:.01,variable:s.surface.thickness},null,8,["step","variable"]),fe,ve,(0,i.wy)((0,i._)("input",{id:"material",type:"number",step:"0.01",min:"1",max:"99","onUpdate:modelValue":t[0]||(t[0]=e=>s.surface.material.index=e)},null,512),[[a.nr,s.surface.material.index,void 0,{number:!0}]]),(0,i._)("span",null," (R="+(0,n.zw)((1/s.surface.shape.curvature.value).toPrecision(4))+") ",1)])}const be=e=>((0,i.dD)("data-v-04e56cad"),e=e(),(0,i.Cn)(),e),we=["step"],ye={class:"ui_block"},ge={class:"ui_block-body"},ke={class:"content"},ze=be((()=>(0,i._)("label",{for:"optimize"},"Optimize",-1)));function Me(e,t,s,l,r,o){return(0,i.wg)(),(0,i.iD)("div",{class:(0,n.C_)(["optic_var_input",{"optic_var_input-editmode":r.editmode,"optic_var_input-optimize":s.variable.optimize}])},[(0,i.wy)((0,i._)("input",{class:"draggable",ref:"input",type:"number","onUpdate:modelValue":t[0]||(t[0]=e=>s.variable.value=e),step:s.step},null,8,we),[[a.nr,s.variable.value]]),r.editmode?((0,i.wg)(),(0,i.iD)("div",{key:0,ref:"menu",class:"optic_var_input-menu",onMousedown:t[2]||(t[2]=(...e)=>o.menuclick&&o.menuclick(...e))},[(0,i._)("div",ye,[(0,i._)("div",ge,[(0,i._)("div",ke,[(0,i.wy)((0,i._)("input",{type:"checkbox",name:"optimize",id:"optimize","onUpdate:modelValue":t[1]||(t[1]=e=>s.variable.optimize=e)},null,512),[[a.e8,s.variable.optimize]]),ze])])])],544)):(0,i.kq)("",!0)],2)}function Oe(e,t){let s=null,a=!1,i=null,n=[];async function l(){a=!0,i=this,n=arguments,null==s&&(s=0,await t.apply(i,n),a=!1,s=setTimeout((function(){s=null,a&&l.apply(i,n)}),e))}return l}function xe(e,t){let s=null,a=!1,i=null,n=[];function l(){a=!0,i=this,n=arguments,null==s&&(t.apply(i,n),a=!1,s=setTimeout((function(){s=null,a&&l.apply(i,n)}),e))}return l}var Ie={props:{variable:N,step:Number},data(){return{editmode:!1,tweakmode:!1,tweaked:!1,tempValue:this.variable.value}},methods:{mousedown(e){this.tempValue=this.variable.value,this.editmode||(e.preventDefault(),this.tweakmode=!0,this.tweaked=!1)},mouseup(e){this.tweakmode&&!this.tweaked&&(this.editmode=!0,this.tweakmode=!1,this.$refs.input.focus()),this.tweakmode=!1},mousemove(e){this.tweakmode&&(this.tweaked=!0,this.tempValue+=e.movementX*this.step,this.updatevalue())},reset(e){this.editmode=!1,this.tweakmode=!1},menuclick(e){e.preventDefault()},updatevalue:xe(10,(function(){this.variable.value=this.tempValue}))},mounted(){this.$refs.input.addEventListener("mousedown",this.mousedown),addEventListener("mouseup",this.mouseup),addEventListener("mousemove",this.mousemove),this.$refs.input.addEventListener("blur",this.reset)},beforeUnmount(){this.$refs.input.removeEventListener("mousedown",this.mousedown),removeEventListener("mouseup",this.mouseup),removeEventListener("mousemove",this.mousemove),this.$refs.input.removeEventListener("blur",this.reset)}};const Ce=(0,ue.Z)(Ie,[["render",Me],["__scopeId","data-v-04e56cad"]]);var Se=Ce,De={props:{surface:q},components:{OpticVarInput:Se},data(){return{}}};const Ee=(0,ue.Z)(De,[["render",_e]]);var Ze=Ee;const Pe={focusedSurface:null,colorlist:["red","green","blue","yellow","cyan","magenta"]};var Te=Pe,Ue={props:{system:G},components:{OpticSurfaceComponent:Ze,SheetUI:de},methods:{buildSurface(e){return new q},hover(e){Te.focusedSurface=e}}};const Ne=(0,ue.Z)(Ue,[["render",y]]);var Ve=Ne;const We=e=>((0,i.dD)("data-v-9796c7f6"),e=e(),(0,i.Cn)(),e),Le={class:"lens_plot ui_block"},$e=We((()=>(0,i._)("div",{class:"ui_block-header"},[(0,i._)("p",null,"Plot")],-1))),je={class:"ui_block-body"},Ae={ref:"container",class:"lens_plot-container"},He={ref:"canvas"};function Fe(e,t,s,a,n,l){return(0,i.wg)(),(0,i.iD)("div",Le,[$e,(0,i._)("div",je,[(0,i._)("div",Ae,[(0,i._)("canvas",He,null,512)],512)])])}function Xe(e,t,s){return V.lub((()=>{let a=[];a.push(t);let i=1,n=V.XeE(0);for(let l of e.surfaces){let e=l.material.index;t=l.shape.trace(t.sub(V.XeE([[0],[0],[1]]).mul(n)),s);let r=l.shape.normal(t);s=s.div(s.mul(s).sum(0).sqrt()).mul(i),r=r.mul(s.mul(r).sum(0).sign());let o=s.mul(r).sum(0),u=V.luU(i**2,o.mul(o)),c=V.luU(e**2,u).sqrt().sub(V.luU(i**2,u).sqrt());s=s.add(r.mul(c)),t=t.add(V.XeE([[0],[0],[1]]).mul(n)),a.push(t),i=e,n=n.add((0,W.IU)(l.thickness.value))}return a}))}var Re=Xe;function qe(e){let t=[],s=[],a=7;for(let i=0;i<=a;i++)for(let n of e.fields){let l=2*(i/a-.5);t.push(n.raypos(0,l,e)),s.push(n.raydir(0,l,e))}return t=V.XeE(t).transpose(),s=V.XeE(s).transpose(),Re(e,t,s)}var Be=qe,Je={props:{system:G},data(){return{canvas:null,ctx:null,ViewState:Te}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:Oe(10,(async function(){if(null===this.ctx)return;const e=this.canvas,t=this.ctx,s=await Promise.all(Be(this.system).map((e=>e.array())));t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2);let a=0;for(let u of this.system.surfaces)a+=u.thickness.value;let i=[],n=0;for(let u=1;u<s.length;u++){let e=0;for(let t=0;t<s[0][0].length;t++){let a=s[u][1][t];isNaN(a)||(e=Math.max(e,Math.abs(a)))}i.push(e),n=Math.max(e,n)}let l=e.width/a*.9;l=Math.min(l,e.height/n/2*.9),t.scale(l,l),t.translate(-a/2,0),t.lineWidth=2/l,t.strokeStyle="#333",t.beginPath(),t.moveTo(0,0),t.lineTo(a,0),t.stroke(),t.strokeStyle="#EEE";const r=50;let o=0;t.fillStyle="#111";for(let u=0;u<this.system.surfaces.length;u++){let e=this.system.surfaces[u],s=i[u],a=u<this.system.surfaces.length-1&&e.material.index>1;a&&(s=Math.max(s,i[u+1])),t.beginPath();for(let i=0;i<=r;i++){let a=2*(i/r-.5)*s,n=e.shape.surface(a);isNaN(a)||isNaN(n)||(0==i?t.moveTo(o+n,a):t.lineTo(o+n,a))}if(a){let a=this.system.surfaces[u+1];for(let i=0;i<=r;i++){let n=2*-(i/r-.5)*s,l=a.shape.surface(n);isNaN(n)||isNaN(l)||t.lineTo(o+l+e.thickness.value,n)}t.closePath(),t.fill()}if(t.stroke(),e==Te.focusedSurface){t.save(),t.strokeStyle="orange",t.lineWidth=3/l,t.beginPath();for(let a=0;a<=r;a++){let i=2*(a/r-.5)*s,n=e.shape.surface(i);isNaN(i)||isNaN(n)||(0==a?t.moveTo(o+n,i):t.lineTo(o+n,i))}t.stroke(),t.restore()}o+=e.thickness.value}t.lineWidth=1.5/l;for(let u=0;u<s[0][0].length;u++){t.strokeStyle=Te.colorlist[u%this.system.fields.length%Te.colorlist.length],t.beginPath();for(let e=0;e<s.length;e++){let a=s[e][1][u],i=s[e][2][u];0==e?t.moveTo(i,a):t.lineTo(i,a)}t.stroke()}}),50)},watch:{system:{handler(){this.update()},deep:!0},ViewState:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const Ke=(0,ue.Z)(Je,[["render",Fe],["__scopeId","data-v-9796c7f6"]]);var Qe=Ke;V.CQI("cpu");const Ye=new G;var Ge={system:Ye};const et={class:"ui_sheet ui_block"},tt=(0,i._)("div",{class:"ui_block-header"},[(0,i._)("p",null,"Field Data")],-1),st={class:"ui_block-body"},at={class:"content"},it=(0,i._)("label",{for:"diameter"},"D=",-1),nt=(0,i._)("label",{for:"Z"},"Z=",-1),lt=(0,i._)("div",{class:"content"},[(0,i._)("p",null,"D=Entrance Diameter, Z=Distance to the pupil")],-1);function rt(e,t,s,a,n,l){const r=(0,i.up)("OpticVarInput"),o=(0,i.up)("OpticFieldComponent"),u=(0,i.up)("SheetUI");return(0,i.wg)(),(0,i.iD)("div",et,[tt,(0,i._)("div",st,[(0,i._)("div",at,[it,(0,i.Wm)(r,{id:"diameter",step:.01,variable:s.system.pupilDiameter},null,8,["step","variable"]),nt,(0,i.Wm)(r,{id:"Z",step:.01,variable:s.system.pupilOffset},null,8,["step","variable"])]),(0,i.Wm)(u,{list:s.system.fields,builder:l.buildField},{item:(0,i.w5)((([e,t])=>[((0,i.wg)(),(0,i.j4)(o,{field:e,key:t},null,8,["field"]))])),_:1},8,["list","builder"]),lt])])}const ot=(0,i._)("label",{for:"angle"},"angle=",-1);function ut(e,t,s,a,n,l){const r=(0,i.up)("OpticVarInput");return(0,i.wg)(),(0,i.iD)("div",null,[ot,(0,i.Wm)(r,{id:"angle",step:.02,variable:s.field.angle},null,8,["step","variable"])])}var ct={props:{field:Q},components:{OpticVarInput:Se},data(){return{}}};const dt=(0,ue.Z)(ct,[["render",ut]]);var ht=dt,pt={props:{system:G},components:{OpticFieldComponent:ht,OpticVarInput:Se,SheetUI:de},methods:{buildField(e){return new Q}}};const mt=(0,ue.Z)(pt,[["render",rt]]);var ft=mt;const vt=e=>((0,i.dD)("data-v-0dfd1afe"),e=e(),(0,i.Cn)(),e),_t={class:"analyze_plot ui_block"},bt=vt((()=>(0,i._)("div",{class:"ui_block-header"},[(0,i._)("p",null,"Spot Diagram")],-1))),wt={class:"ui_block-body"},yt={ref:"container",class:"analyze_plot-container"},gt={ref:"canvas"};function kt(e,t,s,a,n,l){return(0,i.wg)(),(0,i.iD)("div",_t,[bt,(0,i._)("div",wt,[(0,i._)("div",yt,[(0,i._)("canvas",gt,null,512)],512)])])}function zt(e){let t=[],s=[],a=5;for(let l=0;l<=a;l++){let i=l/a,n=16*i+1;for(let a=0;a<n;a++){let l=a/n,r=i*Math.cos(l*Math.PI*2),o=i*Math.sin(l*Math.PI*2);for(let a of e.fields)t.push(a.raypos(r,o,e)),s.push(a.raydir(r,o,e))}}t=V.XeE(t).transpose(),s=V.XeE(s).transpose();let i=Re(e,t,s),n=i[i.length-1];return n}var Mt=zt,Ot={props:{system:G},data(){return{canvas:null,ctx:null}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:Oe(10,(async function(){null===this.ctx&&console.error("ctx not ready");const e=this.canvas,t=this.ctx,s=await Mt(this.system).array();t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2),t.beginPath();let a=s[1][0],i=s[1][0];for(let l=0;l<s[0].length;l++){let e=s[1][l];isNaN(e)||(a=Math.max(e,a),i=Math.min(e,i))}let n=e.height/(a-i+2)*.8;t.scale(n,n),t.translate(0,-(a+i)/2),t.lineWidth=1/n;for(let l=0;l<s[0].length;l++){t.beginPath(),t.strokeStyle=Te.colorlist[l%this.system.fields.length%Te.colorlist.length];let e=s[0][l],a=s[1][l];t.rect(e-1/n,a-1/n,2/n,2/n),t.stroke()}}))},watch:{system:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const xt=(0,ue.Z)(Ot,[["render",kt],["__scopeId","data-v-0dfd1afe"]]);var It=xt;const Ct=e=>((0,i.dD)("data-v-2fd3bb79"),e=e(),(0,i.Cn)(),e),St={class:"optimize_wizard ui_block"},Dt=Ct((()=>(0,i._)("div",{class:"ui_block-header"},"Optimizer",-1))),Et={class:"ui_block-body"},Zt={class:"row content"},Pt=Ct((()=>(0,i._)("label",{for:"updateOnSystemChange"},"Update merit on change",-1))),Tt={class:"row content"},Ut={class:"row content"},Nt={class:"row content"},Vt=Ct((()=>(0,i._)("label",{for:"maxIteration"},"Max:",-1))),Wt={class:"row content"},Lt=Ct((()=>(0,i._)("label",{for:"updateView"},"Update view",-1)));function $t(e,t,s,l,r,o){return(0,i.wg)(),(0,i.iD)("div",St,[Dt,(0,i._)("div",Et,[(0,i._)("div",Zt,[(0,i.wy)((0,i._)("input",{type:"checkbox",name:"updateOnSystemChange",id:"updateOnSystemChange","onUpdate:modelValue":t[0]||(t[0]=e=>r.updateOnSystemChange=e)},null,512),[[a.e8,r.updateOnSystemChange]]),Pt]),(0,i._)("div",Tt,[(0,i._)("p",null,"Current Merit: "+(0,n.zw)(r.merit.toPrecision(6)),1)]),(0,i._)("div",Ut,[(0,i._)("button",{onClick:t[1]||(t[1]=(...e)=>o.updateMerit&&o.updateMerit(...e))},"Calculate Current"),this.iterate?((0,i.wg)(),(0,i.iD)("button",{key:0,onClick:t[2]||(t[2]=(...e)=>o.stop&&o.stop(...e))},"Stop!")):((0,i.wg)(),(0,i.iD)("button",{key:1,onClick:t[3]||(t[3]=(...e)=>o.optimize&&o.optimize(...e))},"Optimize!"))]),(0,i._)("div",Nt,[Vt,(0,i.wy)((0,i._)("input",{type:"number",name:"maxIteration",id:"maxIteration","onUpdate:modelValue":t[4]||(t[4]=e=>r.maxIteration=e)},null,512),[[a.nr,r.maxIteration]]),(0,i._)("p",null,"Iterations: "+(0,n.zw)(r.iterations),1)]),(0,i._)("div",Wt,[(0,i.wy)((0,i._)("input",{type:"checkbox",name:"updateView",id:"updateView","onUpdate:modelValue":t[5]||(t[5]=e=>r.updateView=e)},null,512),[[a.e8,r.updateView]]),Lt])])])}function jt(e){return V.lub((()=>{let t=V.XeE([0]);for(let s of e.fields)t=V.lub((()=>{const a=[],i=[],n=3;for(let t=0;t<=n;t++){const l=t/n,r=3*l+1;for(let t=0;t<=r;t++){const n=t/r-.5,o=l*Math.cos(n*Math.PI),u=l*Math.sin(n*Math.PI);a.push(s.raypos(o,u,e)),i.push(s.raydir(o,u,e))}}const l=V.XeE(a).transpose(),r=V.XeE(i).transpose(),o=Re(e,l,r),u=o[o.length-1],c=u.sub(u.gather(0,1).expandDims(1)),d=c.mul(c),h=d.isNaN().logicalNot(),p=d.where(h,0).max().add(1e5);return t.add(d.where(h,p).sum())}));return t}))}var At=jt;async function Ht(e){let t=[];t.push(e.pupilOffset);for(let f of e.surfaces)t.push(f.shape.curvature),t.push(f.thickness);t=t.filter((e=>e.optimize));let s=t.map(W.IU),a=s.map((e=>e.value));async function i(t){return s.map(((e,s)=>{e.value=t[s]})),(await At(e).array())[0]}async function n(e,t){for(let s=0;s<e.length;s++)t[s]=await i(e[s])}const l=[a];l.push(a.map((e=>e+1*(Math.random()-.5)))),l.push(a.map((e=>e+.01*(Math.random()-.5)))),l.push(a.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),l.push(a.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),l.push(a.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1))),l.push(a.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1)));const r=l.length,o=[],u=[],c=[];await n(l,o);let d=o[0],h=l[0];async function p(e=.9){for(let t=0;t<r;t++){const s=Math.floor(Math.random()*r),a=Math.floor(Math.random()*r),i=Math.floor(Math.random()*r),n=Math.floor(Math.random()*r),o=l[s],u=l[a],d=l[i];c[t]=l[t].map(((t,s)=>s!==n&&Math.random()<.3?t:o[s]+(u[s]-d[s])*e))}await n(c,u);for(let t=0;t<r;t++)!isNaN(u[t])&&u[t]<o[t]&&(o[t]=u[t],l[t]=c[t],(isNaN(d)||o[t]<d)&&(d=o[t],h=l[t]));return d}function m(){s.map(((e,t)=>{e.value=null})),t.map(((e,t)=>{e.value=h[t]}))}return[p.bind(this),m.bind(this)]}var Ft=Ht,Xt={props:{system:G},data(){return{merit:0,iterate:null,apply:null,iterations:0,maxIteration:20,timeout:null,updateOnSystemChange:!0,updateView:!1}},methods:{updateMerit:xe(10,(function(){this.merit=At(this.system).arraySync()[0]})),async optimize(){this.iterations=0;let[e,t]=await Ft(this.system);this.iterate=e,this.apply=t,this.update()},update(){if(this.timeout&&clearTimeout(this.timeout),this.iterations>=this.maxIteration)this.stop();else if(this.iterate){let e=this;this.iterate().then((t=>{this.merit=t,this.updateView&&this.apply(),e.timeout=setTimeout((()=>{e.iterations+=1,e.update()}),0)}))}},stop(){this.apply&&(this.system.update+=1,this.apply(),this.apply=null),this.updateMerit(),this.iterate=null,clearTimeout(this.timeout),this.timeout=null}},watch:{system:{handler(){this.updateOnSystemChange&&!this.iterate&&this.updateMerit()},deep:!0}}};const Rt=(0,ue.Z)(Xt,[["render",$t],["__scopeId","data-v-2fd3bb79"]]);var qt=Rt;function Bt(e,t){let s=null,a=null,i=[];function n(){a=this,i=arguments,s&&clearTimeout(s),s=setTimeout((function(){t.apply(a,i),s=null}),e)}return n}var Jt={name:"App",data(){return{system:Ge.system,state:[],no_record:!1,stateHead:0}},components:{LensSheet:Ve,LensPlot:Qe,FieldSheet:ft,AnalyzePlot:It,OptimizeWizard:qt},mounted(){this.push()},methods:{undo(){this.no_record=!0,this.stateHead>1&&this.stateHead--,this.state.length>0&&this.load(this.state[this.stateHead-1])},redo(){this.no_record=!0,this.stateHead<this.state.length&&this.stateHead++,this.state.length>0&&this.load(this.state[this.stateHead-1])},load(e){this.system=C.deserialize(e)},push:Bt(200,xe(500,(function(){this.state.splice(this.stateHead);let e=C.serialize((0,W.IU)(this.system));0!=this.state.length&&e===this.state[this.state.length-1]||(this.state.push(e),this.stateHead+=1)}))),open(){let e=document.createElement("input");e.type="file";let t=this;e.onchange=function(){const s=new FileReader;s.readAsText(e.files[0],"UTF-8"),s.onload=function(e){t.load(e.target.result)}},e.click()},save(){let e="lens.json";var t=C.serialize((0,W.IU)(this.system)),s=new Blob([t],{type:"text/plain"});new File([s],e,{type:"text/plain"});let a=document.createElement("a");document.createEvent("MouseEvents");a.download=e,a.href=window.URL.createObjectURL(s),a.dataset.downloadurl=["text/obj",a.download,a.href].join(":"),a.click()}},watch:{system:{handler(){this.no_record||this.push(),this.no_record=!1},deep:!0}}};const Kt=(0,ue.Z)(Jt,[["render",f],["__scopeId","data-v-9c94eec8"]]);var Qt=Kt;(0,a.ri)(Qt).mount("#app")},5410:function(){},8628:function(){},1601:function(){},7792:function(){},4977:function(){},5042:function(){}},t={};function s(a){var i=t[a];if(void 0!==i)return i.exports;var n=t[a]={id:a,loaded:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=e,function(){s.amdD=function(){throw new Error("define cannot be used indirect")}}(),function(){s.amdO={}}(),function(){var e=[];s.O=function(t,a,i,n){if(!a){var l=1/0;for(c=0;c<e.length;c++){a=e[c][0],i=e[c][1],n=e[c][2];for(var r=!0,o=0;o<a.length;o++)(!1&n||l>=n)&&Object.keys(s.O).every((function(e){return s.O[e](a[o])}))?a.splice(o--,1):(r=!1,n<l&&(l=n));if(r){e.splice(c--,1);var u=i();void 0!==u&&(t=u)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[a,i,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};s.O.j=function(t){return 0===e[t]};var t=function(t,a){var i,n,l=a[0],r=a[1],o=a[2],u=0;if(l.some((function(t){return 0!==e[t]}))){for(i in r)s.o(r,i)&&(s.m[i]=r[i]);if(o)var c=o(s)}for(t&&t(a);u<l.length;u++)n=l[u],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},a=self["webpackChunkoptictool"]=self["webpackChunkoptictool"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=s.O(void 0,[998],(function(){return s(57)}));a=s.O(a)})();
//# sourceMappingURL=app.8c10f005.js.map