(function(){var e={3675:function(e,t,s){"use strict";var i=s(9242),a=s(3396),n=s(7139);const r=e=>((0,a.dD)("data-v-9c94eec8"),e=e(),(0,a.Cn)(),e),l={class:"container"},o={class:"row"},u=r((()=>(0,a._)("h2",null,"Optic Tool ",-1))),c=r((()=>(0,a._)("div",null,null,-1))),d=r((()=>(0,a._)("div",null,null,-1))),h={class:"row top_row"},p={class:"row"},m=(0,a.uE)('<div class="row" data-v-9c94eec8><div class="content" data-v-9c94eec8><h3 data-v-9c94eec8>About this project</h3><p data-v-9c94eec8>Developer: <a href="https://chiuhans111.github.io" data-v-9c94eec8>Hans Chiu</a></p><p data-v-9c94eec8>Project repo: <a href="https://github.com/chiuhans111/OpticTool" data-v-9c94eec8>https://github.com/chiuhans111/OpticTool</a></p></div><div class="content" data-v-9c94eec8><h3 data-v-9c94eec8>How to use?</h3><p data-v-9c94eec8>Drag the input box to modify value.</p><p data-v-9c94eec8>Click the input box to edit and set optimization variable.</p></div></div>',1);function f(e,t,s,i,r,f){const v=(0,a.up)("LensPlot"),_=(0,a.up)("AnalyzePlot"),b=(0,a.up)("LensSheet"),w=(0,a.up)("FieldSheet"),y=(0,a.up)("OptimizeWizard");return(0,a.wg)(),(0,a.iD)("div",l,[(0,a._)("div",o,[u,c,(0,a._)("button",{onClick:t[0]||(t[0]=(...e)=>f.open&&f.open(...e))},"Open"),(0,a._)("button",{onClick:t[1]||(t[1]=(...e)=>f.save&&f.save(...e))},"Save"),d,(0,a._)("button",{onClick:t[2]||(t[2]=(...e)=>f.undo&&f.undo(...e))},"Undo "+(0,n.zw)(this.stateHead-1),1),(0,a._)("button",{onClick:t[3]||(t[3]=(...e)=>f.redo&&f.redo(...e))},"Redo "+(0,n.zw)(this.state.length-this.stateHead),1)]),(0,a._)("div",h,[(0,a.Wm)(v,{system:r.system},null,8,["system"]),(0,a.Wm)(_,{system:r.system},null,8,["system"])]),(0,a._)("div",p,[(0,a.Wm)(b,{system:r.system},null,8,["system"]),(0,a.Wm)(w,{system:r.system},null,8,["system"]),(0,a.Wm)(y,{system:r.system},null,8,["system"])]),m])}s(7658);const v={class:"ui_sheet ui_block"},_=(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Lens Data")],-1),b={class:"ui_block-body"},w=(0,a._)("div",{class:"content"},[(0,a._)("p",null,"t=thickness, c=curvature (1/R), n=index of refraction")],-1);function y(e,t,s,i,n,r){const l=(0,a.up)("OpticSurfaceComponent"),o=(0,a.up)("SheetUI");return(0,a.wg)(),(0,a.iD)("div",v,[_,(0,a._)("div",b,[(0,a.Wm)(o,{list:s.system.surfaces,builder:r.buildSurface},{item:(0,a.w5)((([e,t])=>[((0,a.wg)(),(0,a.j4)(l,{surface:e,key:t},null,8,["surface"]))])),_:1},8,["list","builder"]),w])])}var g=s(7327);function k(e){return e=e.replaceAll(/"([^",{}]+)":/g,"$1:"),e=e.replaceAll(/{_:"([^",{}]+)",/g,"{$1,"),e=e.replaceAll(/true/g,"_1"),e=e.replaceAll(/false/g,"_0"),e}function z(e){return e=e.replaceAll(/_1/g,"true"),e=e.replaceAll(/_0/g,"false"),e=e.replaceAll(/{([^",{}]+),/g,'{_:"$1",'),e=e.replaceAll(/([^,"{}]+):/g,'"$1":'),e}class M{constructor(){(0,g.Z)(this,"classdefs",{}),(0,g.Z)(this,"classnames",{})}serializable(e,t){const s=this;return function(i){e in s.classdefs&&console.error("duplicated classname",e),i.name in s.classnames&&console.error("duplicated class",i.name);const a={};for(let e in t)a[t[e]]=e;return s.classdefs[e]={Class:i,param2v:t,v2param:a},s.classnames[i.name]=e,i}}serialize(e){return k(JSON.stringify(this._serialize(e)))}_serialize(e){if(e instanceof Array)return e.map((e=>this._serialize(e)));if(e instanceof Object){const t={};if(e.constructor.name in this.classnames){t._=this.classnames[e.constructor.name];const s=this.classdefs[t._].param2v;for(let i in s)t[s[i]]=this._serialize(e[i])}else for(let s in e)t[s]=this._serialize(e[s]);return t}return e}deserialize(e,t){return this._deserialize(JSON.parse(z(e)),t)}_deserialize(e){if(e instanceof Array)return e.map((e=>this._deserialize(e)));if(e instanceof Object){if(e._&&e._ in this.classdefs){const t=this.classdefs[e._],s=new t.Class,i=t.v2param;for(let a in i)s[i[a]]=this._deserialize(e[a]);return s}{const t={};for(let s in e)t[s]=this._deserialize(e[s]);return t}}return e}}const O=new M;var x,C,I=O;let S=(x=I.serializable("n",{index:"n"}),x(C=class{constructor(e){(0,g.Z)(this,"index",1),this.index=e||this.index}})||C);var D,E,N=S;let Z=(D=I.serializable("v",{value:"v",optimize:"o"}),D(E=class{constructor(e){(0,g.Z)(this,"value",0),(0,g.Z)(this,"optimize",!1),this.value=e||0}num(){const e=Number(this.value);return isNaN(e)?0:e}})||E);var P,T,U=Z,V=s(5789);let W=(P=I.serializable("o",{curvature:"c"}),P(T=class{constructor(e){(0,g.Z)(this,"curvature",new U(0)),this.curvature.value=e||this.curvature.value}trace(e,t){const s=this.curvature.num();return V.lub((()=>{let i=e.gather(2).div(t.gather(2)).mul(-1);if(0!=s){const a=t.mul(t).sum(0).mul(s),n=e.mul(t).sum(0).mul(s).sub(t.gather(2)).mul(2),r=e.mul(e).sum(0).mul(s).sub(e.gather(2).mul(2));i=n.mul(-1).sub(n.mul(n).sub(a.mul(r).mul(4)).sqrt()).div(a).div(2),a.dispose(),n.dispose(),r.dispose()}return e.add(t.mul(i))}))}normal(e){const t=this.curvature.num();return V.lub((()=>{let s=e.mul(0).add(V.XeE([[0],[0],[-1]]));if(0!=t){let i=e.sub(V.XeE([[0],[0],[1]]).div(t));s=i.div(i.mul(i).sum(0).sqrt())}return s}))}surface(e){const t=e**2;return t*this.curvature.num()/(1+Math.sqrt(1-t*this.curvature.num()**2))}})||T);var L,$,j=W;let A=(L=I.serializable("s",{thickness:"t",shape:"s",material:"n"}),L($=class{constructor(e,t,s){(0,g.Z)(this,"thickness",new U),(0,g.Z)(this,"shape",new j),(0,g.Z)(this,"material",new N),this.thickness.value=e||this.thickness.value,this.shape.curvature.value=t||this.shape.curvature.value,this.material=s||this.material}})||$);var H,X,F=A;let R=(H=I.serializable("f",{angle:"a"}),H(X=class{constructor(e){(0,g.Z)(this,"angle",new U(0)),this.angle.value=e||this.angle.value}raypos(e,t,s){const i=s.pupilDiameter.num()/2,a=s.pupilOffset.num(),n=this.angle.num(),r=-1,l=e*i,o=t*i+(a-r)*Math.sin(n/180*Math.PI);return[l,o,r]}raydir(e,t){return[0,-Math.sin(this.angle.num()/180*Math.PI),Math.cos(this.angle.num()/180*Math.PI)]}})||X);var q,B,J=R;let K=(q=I.serializable("$",{surfaces:"s",fields:"f",pupilDiameter:"D",pupilOffset:"Z"}),q(B=class{constructor(){(0,g.Z)(this,"surfaces",[new F(3,.066667,new N(1.515)),new F(4,-.01316,new N(1)),new F(1.5,-.05882,new N(1.6438)),new F(2.5,.0625,new N(1)),new F(3,.022727,new N(1.515)),new F(40,-.07143,new N(1)),new F(0,0,new N(1))]),(0,g.Z)(this,"fields",[new J(0),new J(10),new J(20)]),(0,g.Z)(this,"pupilDiameter",new U(10)),(0,g.Z)(this,"pupilOffset",new U(10)),(0,g.Z)(this,"update",0)}})||B);var Q=K;const Y={class:"ui_sheet"},G={class:"row"},ee={class:"ui_sheet-row-ui"},te=["onClick"],se=["onClick"],ie={class:"ui_sheet-row"},ae={class:"row"};function ne(e,t,s,r,l,o){return(0,a.wg)(),(0,a.iD)("div",Y,[(0,a.Wm)(i.W3,{name:"list",tag:"div",class:"ui_sheet-group"},{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(s.list,((t,s)=>((0,a.wg)(),(0,a.iD)("div",{class:"ui_sheet-row list-item",key:o.getid(t)},[(0,a._)("div",G,[(0,a._)("div",ee,[(0,a._)("button",{class:"ui_sheet-btn",onClick:e=>o.delItem(s)},"Del",8,te),(0,a._)("button",{class:"ui_sheet-btn",onClick:e=>o.addItem(s)},"Add",8,se)]),(0,a.WI)(e.$slots,"item",(0,n.vs)((0,a.F4)([t,s])))])])))),128))])),_:3}),(0,a._)("div",ie,[(0,a._)("div",ae,[(0,a._)("button",{onClick:t[0]||(t[0]=e=>o.addItem(s.list.length))},"Add")])])])}var re=s(4870),le={props:{list:Array,builder:Function},methods:{addItem(e){this.list.splice(e,0,this.builder(e))},delItem(e){this.list.splice(e,1)},getid(e){if(e=(0,re.IU)(e),void 0===e._id_){let t=0;while(this.list.some((e=>e._id_==t)))t++;e._id_=t}return e._id_}}},oe=s(89);const ue=(0,oe.Z)(le,[["render",ne]]);var ce=ue;const de=(0,a._)("label",{for:"curvature"},"c=",-1),he=(0,a._)("span",null,", ",-1),pe=(0,a._)("label",{for:"thickness"},"t=",-1),me=(0,a._)("span",null,", ",-1),fe=(0,a._)("label",{for:"material"},"n=",-1);function ve(e,t,s,r,l,o){const u=(0,a.up)("OpticVarInput");return(0,a.wg)(),(0,a.iD)("tr",null,[de,(0,a.Wm)(u,{id:"curvature",type:"number",step:1e-4,variable:s.surface.shape.curvature},null,8,["step","variable"]),he,pe,(0,a.Wm)(u,{id:"thickness",step:.01,variable:s.surface.thickness},null,8,["step","variable"]),me,fe,(0,a.wy)((0,a._)("input",{id:"material",type:"number",step:"0.01",min:"1",max:"99","onUpdate:modelValue":t[0]||(t[0]=e=>s.surface.material.index=e)},null,512),[[i.nr,s.surface.material.index,void 0,{number:!0}]]),(0,a._)("span",null," (R="+(0,n.zw)((1/s.surface.shape.curvature.value).toPrecision(4))+") ",1)])}const _e=e=>((0,a.dD)("data-v-7c9c4ef9"),e=e(),(0,a.Cn)(),e),be=["step"],we={class:"ui_block"},ye={class:"ui_block-body"},ge={class:"content"},ke=_e((()=>(0,a._)("label",{for:"optimize"},"Optimize",-1)));function ze(e,t,s,r,l,o){return(0,a.wg)(),(0,a.iD)("div",{class:(0,n.C_)(["optic_var_input",{"optic_var_input-editmode":l.editmode,"optic_var_input-optimize":s.variable.optimize}])},[(0,a.wy)((0,a._)("input",{class:"draggable",ref:"input",type:"number","onUpdate:modelValue":t[0]||(t[0]=e=>s.variable.value=e),step:s.step},null,8,be),[[i.nr,s.variable.value,void 0,{number:!0}]]),l.editmode?((0,a.wg)(),(0,a.iD)("div",{key:0,ref:"menu",class:"optic_var_input-menu",onMousedown:t[2]||(t[2]=(...e)=>o.menuclick&&o.menuclick(...e))},[(0,a._)("div",we,[(0,a._)("div",ye,[(0,a._)("div",ge,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"optimize",id:"optimize","onUpdate:modelValue":t[1]||(t[1]=e=>s.variable.optimize=e)},null,512),[[i.e8,s.variable.optimize]]),ke])])])],544)):(0,a.kq)("",!0)],2)}function Me(e,t){let s=null,i=!1,a=null,n=[];async function r(){i=!0,a=this,n=arguments,null==s&&(s=0,await t.apply(a,n),i=!1,s=setTimeout((function(){s=null,i&&r.apply(a,n)}),e))}return r}function Oe(e,t){let s=null,i=!1,a=null,n=[];function r(){i=!0,a=this,n=arguments,null==s&&(t.apply(a,n),i=!1,s=setTimeout((function(){s=null,i&&r.apply(a,n)}),e))}return r}var xe={props:{variable:U,step:Number},data(){return{editmode:!1,tweakmode:!1,tweaked:!1,tempValue:this.variable.value}},methods:{mousedown(e){this.tempValue=this.variable.num(),this.editmode||(e.preventDefault(),this.tweakmode=!0,this.tweaked=!1)},mouseup(e){this.tweakmode&&!this.tweaked&&(this.editmode=!0,this.tweakmode=!1,this.$refs.input.focus()),this.tweakmode=!1},mousemove(e){this.tweakmode&&0!=e.movementX&&(this.tweaked=!0,this.tempValue+=e.movementX*this.step,this.updatevalue())},reset(e){this.editmode=!1,this.tweakmode=!1},menuclick(e){e.preventDefault()},updatevalue:Oe(10,(function(){this.variable.value=this.tempValue}))},mounted(){this.$refs.input.addEventListener("mousedown",this.mousedown),addEventListener("mouseup",this.mouseup),addEventListener("mousemove",this.mousemove),this.$refs.input.addEventListener("blur",this.reset)},beforeUnmount(){this.$refs.input.removeEventListener("mousedown",this.mousedown),removeEventListener("mouseup",this.mouseup),removeEventListener("mousemove",this.mousemove),this.$refs.input.removeEventListener("blur",this.reset)}};const Ce=(0,oe.Z)(xe,[["render",ze],["__scopeId","data-v-7c9c4ef9"]]);var Ie=Ce,Se={props:{surface:F},components:{OpticVarInput:Ie},data(){return{}}};const De=(0,oe.Z)(Se,[["render",ve]]);var Ee=De;const Ne={focusedSurface:null,colorlist:["red","green","blue","yellow","cyan","magenta"]};var Ze=Ne,Pe={props:{system:Q},components:{OpticSurfaceComponent:Ee,SheetUI:ce},methods:{buildSurface(e){return new F},hover(e){Ze.focusedSurface=e}}};const Te=(0,oe.Z)(Pe,[["render",y]]);var Ue=Te;const Ve=e=>((0,a.dD)("data-v-59899f99"),e=e(),(0,a.Cn)(),e),We={class:"lens_plot ui_block"},Le=Ve((()=>(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Plot")],-1))),$e={class:"ui_block-body"},je={ref:"container",class:"lens_plot-container"},Ae={ref:"canvas"};function He(e,t,s,i,n,r){return(0,a.wg)(),(0,a.iD)("div",We,[Le,(0,a._)("div",$e,[(0,a._)("div",je,[(0,a._)("canvas",Ae,null,512)],512)])])}function Xe(e,t,s){return V.lub((()=>{let i=[];i.push(t);let a=1,n=V.XeE(0);for(let r of e.surfaces){let e=Number(r.material.index)||1;t=r.shape.trace(t.sub(V.XeE([[0],[0],[1]]).mul(n)),s);let l=r.shape.normal(t);s=s.div(s.mul(s).sum(0).sqrt()).mul(a),l=l.mul(s.mul(l).sum(0).sign());let o=s.mul(l).sum(0),u=V.luU(a**2,o.mul(o)),c=V.luU(e**2,u).sqrt().sub(V.luU(a**2,u).sqrt());s=s.add(l.mul(c)),t=t.add(V.XeE([[0],[0],[1]]).mul(n)),i.push(t),a=e,n=n.add((0,re.IU)(r.thickness.num()))}return i}))}var Fe=Xe;function Re(e){let t=[],s=[],i=7;for(let a=0;a<=i;a++)for(let n of e.fields){let r=2*(a/i-.5);t.push(n.raypos(0,r,e)),s.push(n.raydir(0,r,e))}return t=V.XeE(t).transpose(),s=V.XeE(s).transpose(),Fe(e,t,s)}var qe=Re,Be={props:{system:Q},data(){return{canvas:null,ctx:null,ViewState:Ze}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:Me(10,(async function(){if(null===this.ctx)return;const e=this.canvas,t=this.ctx,s=await Promise.all(qe(this.system).map((e=>e.array())));t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2);let i=0;for(let u of this.system.surfaces)i+=u.thickness.num();let a=[],n=0;for(let u=1;u<s.length;u++){let e=0;for(let t=0;t<s[0][0].length;t++){let i=s[u][1][t];isNaN(i)||(e=Math.max(e,Math.abs(i)))}a.push(e),n=Math.max(e,n)}let r=e.width/i*.9;r=Math.min(r,e.height/n/2*.9),t.scale(r,r),t.translate(-i/2,0),t.lineWidth=2/r,t.strokeStyle="#333",t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.stroke(),t.strokeStyle="#EEE";const l=50;let o=0;t.fillStyle="#111";for(let u=0;u<this.system.surfaces.length;u++){let e=this.system.surfaces[u],s=a[u],i=u<this.system.surfaces.length-1&&e.material.index>1;i&&(s=Math.max(s,a[u+1])),t.beginPath();for(let a=0;a<=l;a++){let i=2*(a/l-.5)*s,n=e.shape.surface(i);isNaN(i)||isNaN(n)||(0==a?t.moveTo(o+n,i):t.lineTo(o+n,i))}if(i){let i=this.system.surfaces[u+1];for(let a=0;a<=l;a++){let n=2*-(a/l-.5)*s,r=i.shape.surface(n);isNaN(n)||isNaN(r)||t.lineTo(o+r+e.thickness.value,n)}t.closePath(),t.fill()}if(t.stroke(),e==Ze.focusedSurface){t.save(),t.strokeStyle="orange",t.lineWidth=3/r,t.beginPath();for(let i=0;i<=l;i++){let a=2*(i/l-.5)*s,n=e.shape.surface(a);isNaN(a)||isNaN(n)||(0==i?t.moveTo(o+n,a):t.lineTo(o+n,a))}t.stroke(),t.restore()}o+=e.thickness.value}t.lineWidth=1.5/r;for(let u=0;u<s[0][0].length;u++){t.strokeStyle=Ze.colorlist[u%this.system.fields.length%Ze.colorlist.length],t.beginPath();for(let e=0;e<s.length;e++){let i=s[e][1][u],a=s[e][2][u];0==e?t.moveTo(a,i):t.lineTo(a,i)}t.stroke()}}),50)},watch:{system:{handler(){this.update()},deep:!0},ViewState:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const Je=(0,oe.Z)(Be,[["render",He],["__scopeId","data-v-59899f99"]]);var Ke=Je;V.CQI("cpu");const Qe=new Q;var Ye={system:Qe};const Ge={class:"ui_sheet ui_block"},et=(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Field Data")],-1),tt={class:"ui_block-body"},st={class:"content"},it=(0,a._)("label",{for:"diameter"},"D=",-1),at=(0,a._)("label",{for:"Z"},"Z=",-1),nt=(0,a._)("div",{class:"content"},[(0,a._)("p",null,"D=Entrance Diameter, Z=Distance to the pupil")],-1);function rt(e,t,s,i,n,r){const l=(0,a.up)("OpticVarInput"),o=(0,a.up)("OpticFieldComponent"),u=(0,a.up)("SheetUI");return(0,a.wg)(),(0,a.iD)("div",Ge,[et,(0,a._)("div",tt,[(0,a._)("div",st,[it,(0,a.Wm)(l,{id:"diameter",step:.01,variable:s.system.pupilDiameter},null,8,["step","variable"]),at,(0,a.Wm)(l,{id:"Z",step:.01,variable:s.system.pupilOffset},null,8,["step","variable"])]),(0,a.Wm)(u,{list:s.system.fields,builder:r.buildField},{item:(0,a.w5)((([e,t])=>[((0,a.wg)(),(0,a.j4)(o,{field:e,key:t},null,8,["field"]))])),_:1},8,["list","builder"]),nt])])}const lt=(0,a._)("label",{for:"angle"},"angle=",-1);function ot(e,t,s,i,n,r){const l=(0,a.up)("OpticVarInput");return(0,a.wg)(),(0,a.iD)("div",null,[lt,(0,a.Wm)(l,{id:"angle",step:.02,variable:s.field.angle},null,8,["step","variable"])])}var ut={props:{field:J},components:{OpticVarInput:Ie},data(){return{}}};const ct=(0,oe.Z)(ut,[["render",ot]]);var dt=ct,ht={props:{system:Q},components:{OpticFieldComponent:dt,OpticVarInput:Ie,SheetUI:ce},methods:{buildField(e){return new J}}};const pt=(0,oe.Z)(ht,[["render",rt]]);var mt=pt;const ft=e=>((0,a.dD)("data-v-0dfd1afe"),e=e(),(0,a.Cn)(),e),vt={class:"analyze_plot ui_block"},_t=ft((()=>(0,a._)("div",{class:"ui_block-header"},[(0,a._)("p",null,"Spot Diagram")],-1))),bt={class:"ui_block-body"},wt={ref:"container",class:"analyze_plot-container"},yt={ref:"canvas"};function gt(e,t,s,i,n,r){return(0,a.wg)(),(0,a.iD)("div",vt,[_t,(0,a._)("div",bt,[(0,a._)("div",wt,[(0,a._)("canvas",yt,null,512)],512)])])}function kt(e){let t=[],s=[],i=5;for(let r=0;r<=i;r++){let a=r/i,n=16*a+1;for(let i=0;i<n;i++){let r=i/n,l=a*Math.cos(r*Math.PI*2),o=a*Math.sin(r*Math.PI*2);for(let i of e.fields)t.push(i.raypos(l,o,e)),s.push(i.raydir(l,o,e))}}t=V.XeE(t).transpose(),s=V.XeE(s).transpose();let a=Fe(e,t,s),n=a[a.length-1];return n}var zt=kt,Mt={props:{system:Q},data(){return{canvas:null,ctx:null}},methods:{resize(){const e=this.$refs.container.getBoundingClientRect();this.$refs.canvas.width=e.width,this.$refs.canvas.height=e.height,this.update()},update:Me(10,(async function(){null===this.ctx&&console.error("ctx not ready");const e=this.canvas,t=this.ctx,s=await zt(this.system).array();t.resetTransform(),t.clearRect(0,0,e.width,e.height),t.translate(e.width/2,e.height/2),t.beginPath();let i=s[1][0],a=s[1][0];for(let r=0;r<s[0].length;r++){let e=s[1][r];isNaN(e)||(i=Math.max(e,i),a=Math.min(e,a))}let n=e.height/(i-a+2)*.8;t.scale(n,n),t.translate(0,-(i+a)/2),t.lineWidth=1/n;for(let r=0;r<s[0].length;r++){t.beginPath(),t.strokeStyle=Ze.colorlist[r%this.system.fields.length%Ze.colorlist.length];let e=s[0][r],i=s[1][r];t.rect(e-1/n,i-1/n,2/n,2/n),t.stroke()}}))},watch:{system:{handler(){this.update()},deep:!0}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),addEventListener("resize",this.resize),this.resize()},unmounted(){removeEventListener("resize",this.resize)}};const Ot=(0,oe.Z)(Mt,[["render",gt],["__scopeId","data-v-0dfd1afe"]]);var xt=Ot;const Ct=e=>((0,a.dD)("data-v-2fd3bb79"),e=e(),(0,a.Cn)(),e),It={class:"optimize_wizard ui_block"},St=Ct((()=>(0,a._)("div",{class:"ui_block-header"},"Optimizer",-1))),Dt={class:"ui_block-body"},Et={class:"row content"},Nt=Ct((()=>(0,a._)("label",{for:"updateOnSystemChange"},"Update merit on change",-1))),Zt={class:"row content"},Pt={class:"row content"},Tt={class:"row content"},Ut=Ct((()=>(0,a._)("label",{for:"maxIteration"},"Max:",-1))),Vt={class:"row content"},Wt=Ct((()=>(0,a._)("label",{for:"updateView"},"Update view",-1)));function Lt(e,t,s,r,l,o){return(0,a.wg)(),(0,a.iD)("div",It,[St,(0,a._)("div",Dt,[(0,a._)("div",Et,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"updateOnSystemChange",id:"updateOnSystemChange","onUpdate:modelValue":t[0]||(t[0]=e=>l.updateOnSystemChange=e)},null,512),[[i.e8,l.updateOnSystemChange]]),Nt]),(0,a._)("div",Zt,[(0,a._)("p",null,"Current Merit: "+(0,n.zw)(l.merit.toPrecision(6)),1)]),(0,a._)("div",Pt,[(0,a._)("button",{onClick:t[1]||(t[1]=(...e)=>o.updateMerit&&o.updateMerit(...e))},"Calculate Current"),this.iterate?((0,a.wg)(),(0,a.iD)("button",{key:0,onClick:t[2]||(t[2]=(...e)=>o.stop&&o.stop(...e))},"Stop!")):((0,a.wg)(),(0,a.iD)("button",{key:1,onClick:t[3]||(t[3]=(...e)=>o.optimize&&o.optimize(...e))},"Optimize!"))]),(0,a._)("div",Tt,[Ut,(0,a.wy)((0,a._)("input",{type:"number",name:"maxIteration",id:"maxIteration","onUpdate:modelValue":t[4]||(t[4]=e=>l.maxIteration=e)},null,512),[[i.nr,l.maxIteration]]),(0,a._)("p",null,"Iterations: "+(0,n.zw)(l.iterations),1)]),(0,a._)("div",Vt,[(0,a.wy)((0,a._)("input",{type:"checkbox",name:"updateView",id:"updateView","onUpdate:modelValue":t[5]||(t[5]=e=>l.updateView=e)},null,512),[[i.e8,l.updateView]]),Wt])])])}function $t(e){return V.lub((()=>{let t=V.XeE([0]);for(let s of e.fields)t=V.lub((()=>{const i=[],a=[],n=3;for(let t=0;t<=n;t++){const r=t/n,l=3*r+1;for(let t=0;t<=l;t++){const n=t/l-.5,o=r*Math.cos(n*Math.PI),u=r*Math.sin(n*Math.PI);i.push(s.raypos(o,u,e)),a.push(s.raydir(o,u,e))}}const r=V.XeE(i).transpose(),l=V.XeE(a).transpose(),o=Fe(e,r,l),u=o[o.length-1],c=u.sub(u.gather(0,1).expandDims(1)),d=c.mul(c),h=d.isNaN().logicalNot(),p=d.where(h,0).max().add(1e5);return t.add(d.where(h,p).sum())}));return t}))}var jt=$t;async function At(e){let t=[];t.push(e.pupilOffset);for(let f of e.surfaces)t.push(f.shape.curvature),t.push(f.thickness);t=t.filter((e=>e.optimize));let s=t.map(re.IU),i=s.map((e=>e.num()));async function a(t){return s.map(((e,s)=>{e.value=t[s]})),(await jt(e).array())[0]}async function n(e,t){for(let s=0;s<e.length;s++)t[s]=await a(e[s])}const r=[i];r.push(i.map((e=>e+1*(Math.random()-.5)))),r.push(i.map((e=>e+.01*(Math.random()-.5)))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.01)*.5))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1))),r.push(i.map((e=>e+(Math.random()-.5)*(Math.abs(e)+.1)*.1)));const l=r.length,o=[],u=[],c=[];await n(r,o);let d=o[0],h=r[0];async function p(e=.9){for(let t=0;t<l;t++){const s=Math.floor(Math.random()*l),i=Math.floor(Math.random()*l),a=Math.floor(Math.random()*l),n=Math.floor(Math.random()*l),o=r[s],u=r[i],d=r[a];c[t]=r[t].map(((t,s)=>s!==n&&Math.random()<.3?t:o[s]+(u[s]-d[s])*e))}await n(c,u);for(let t=0;t<l;t++)!isNaN(u[t])&&u[t]<o[t]&&(o[t]=u[t],r[t]=c[t],(isNaN(d)||o[t]<d)&&(d=o[t],h=r[t]));return d}function m(){s.map(((e,t)=>{e.value=null})),t.map(((e,t)=>{e.value=h[t]}))}return[p.bind(this),m.bind(this)]}var Ht=At,Xt={props:{system:Q},data(){return{merit:0,iterate:null,apply:null,iterations:0,maxIteration:20,timeout:null,updateOnSystemChange:!0,updateView:!1}},methods:{updateMerit:Oe(10,(function(){this.merit=jt(this.system).arraySync()[0]})),async optimize(){this.iterations=0;let[e,t]=await Ht(this.system);this.iterate=e,this.apply=t,this.update()},update(){if(this.timeout&&clearTimeout(this.timeout),this.iterations>=this.maxIteration)this.stop();else if(this.iterate){let e=this;this.iterate().then((t=>{this.merit=t,this.updateView&&this.apply(),e.timeout=setTimeout((()=>{e.iterations+=1,e.update()}),0)}))}},stop(){this.apply&&(this.system.update+=1,this.apply(),this.apply=null),this.updateMerit(),this.iterate=null,clearTimeout(this.timeout),this.timeout=null}},watch:{system:{handler(){this.updateOnSystemChange&&!this.iterate&&this.updateMerit()},deep:!0}}};const Ft=(0,oe.Z)(Xt,[["render",Lt],["__scopeId","data-v-2fd3bb79"]]);var Rt=Ft;function qt(e,t){let s=null,i=null,a=[];function n(){i=this,a=arguments,s&&clearTimeout(s),s=setTimeout((function(){t.apply(i,a),s=null}),e)}return n}var Bt={name:"App",data(){return{system:Ye.system,state:[],no_record:!1,stateHead:0}},components:{LensSheet:Ue,LensPlot:Ke,FieldSheet:mt,AnalyzePlot:xt,OptimizeWizard:Rt},mounted(){this.push()},methods:{undo(){this.no_record=!0,this.stateHead>1&&this.stateHead--,this.state.length>0&&this.load(this.state[this.stateHead-1])},redo(){this.no_record=!0,this.stateHead<this.state.length&&this.stateHead++,this.state.length>0&&this.load(this.state[this.stateHead-1])},load(e){this.system=I.deserialize(e)},push:qt(200,Oe(500,(function(){this.state.splice(this.stateHead);let e=I.serialize((0,re.IU)(this.system));0!=this.state.length&&e===this.state[this.state.length-1]||(this.state.push(e),this.stateHead+=1)}))),open(){let e=document.createElement("input");e.type="file";let t=this;e.onchange=function(){const s=new FileReader;s.readAsText(e.files[0],"UTF-8"),s.onload=function(e){t.load(e.target.result)}},e.click()},save(){let e="lens.json";var t=I.serialize((0,re.IU)(this.system)),s=new Blob([t],{type:"text/plain"});new File([s],e,{type:"text/plain"});let i=document.createElement("a");document.createEvent("MouseEvents");i.download=e,i.href=window.URL.createObjectURL(s),i.dataset.downloadurl=["text/obj",i.download,i.href].join(":"),i.click()}},watch:{system:{handler(){this.no_record||this.push(),this.no_record=!1},deep:!0}}};const Jt=(0,oe.Z)(Bt,[["render",f],["__scopeId","data-v-9c94eec8"]]);var Kt=Jt;(0,i.ri)(Kt).mount("#app")},5410:function(){},8628:function(){},1601:function(){},7792:function(){},4977:function(){},5042:function(){}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=e,function(){s.amdD=function(){throw new Error("define cannot be used indirect")}}(),function(){s.amdO={}}(),function(){var e=[];s.O=function(t,i,a,n){if(!i){var r=1/0;for(c=0;c<e.length;c++){i=e[c][0],a=e[c][1],n=e[c][2];for(var l=!0,o=0;o<i.length;o++)(!1&n||r>=n)&&Object.keys(s.O).every((function(e){return s.O[e](i[o])}))?i.splice(o--,1):(l=!1,n<r&&(r=n));if(l){e.splice(c--,1);var u=a();void 0!==u&&(t=u)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[i,a,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var a,n,r=i[0],l=i[1],o=i[2],u=0;if(r.some((function(t){return 0!==e[t]}))){for(a in l)s.o(l,a)&&(s.m[a]=l[a]);if(o)var c=o(s)}for(t&&t(i);u<r.length;u++)n=r[u],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},i=self["webpackChunkoptictool"]=self["webpackChunkoptictool"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[998],(function(){return s(3675)}));i=s.O(i)})();
//# sourceMappingURL=app.45dca32e.js.map